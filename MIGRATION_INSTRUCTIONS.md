# Инструкция по миграции русских имен

## Обзор
Данная миграция исправляет все имена пользователей в базе данных, заменяя английские имена на русские и синхронизируя все связанные таблицы.

## Файлы миграции
1. `migration_fix_russian_names.sql` - основной скрипт миграции
2. `migration_additional_cleanup.sql` - дополнительная очистка и проверки

## Что будет изменено

### Таблица `users`
- **Username**: автогенерированные `vk_ID` заменятся на "Имя Фамилия"
- **First_name**: английские имена заменятся на русские
- **Last_name**: английские фамилии заменятся на русские

### Таблица `vk_whitelist` 
- **Username**: обновится до русских имен

### Таблица `budget`
- **Contributor_name**: все краткие имена заменятся на полные русские "Имя Фамилия"
- **User_id**: автоматически свяжется с соответствующими пользователями

### Таблица `inventory`
- **Owner**: все краткие имена заменятся на полные русские "Имя Фамилия"  
- **Created_by_user_id**: автоматически свяжется с соответствующими пользователями

## Специальные соответствия

| Старое имя | Новое имя |
|------------|-----------|
| Ромэо/Romeo | Роман Эссенов |
| Рома | Роман Кощеев |
| Настя/Nastya | Анастасия Курбатова |
| Мэг/Магдалена | Екатерина Лягушкина |
| Даня/Daniel | Даниил Жуков |
| Эйнар/Einar | Влад Бессонов |
| Илья | Идущий-В Дали |

## Порядок выполнения

### 1. Резервное копирование
```bash
# Создайте резервную копию БД перед миграцией
pg_dump your_database > backup_before_migration.sql
```

### 2. Выполнение основной миграции
```bash
psql -d your_database -f migration_fix_russian_names.sql
```

### 3. Выполнение дополнительной очистки
```bash
psql -d your_database -f migration_additional_cleanup.sql
```

### 4. Проверка результатов
После выполнения скриптов проверьте отчеты, которые покажут:
- Обновленные данные пользователей
- Статистику связывания записей
- Несвязанные записи (требующие ручной доработки)

## Ожидаемые результаты

### Пользователи (примеры)
- `vk_333262027` → `Владимир Маскаев`
- `vk_549564517` → `Роман Эссенов` 
- `vk_648706589` → `Роман Кощеев`

### Budget записи
- `contributor_name: "Владимир"` → `"Владимир Маскаев"`
- `contributor_name: "Роман"` → `"Роман Эссенов"`

### Inventory записи  
- `owner: "Ромэо"` → `"Роман Эссенов"`
- `owner: "Настя"` → `"Анастасия Курбатова"`

## Возможные проблемы и решения

### 1. Несвязанные записи
Если некоторые записи остались без `user_id`, используйте ручные запросы:
```sql
UPDATE budget SET user_id = (SELECT id FROM users WHERE username = 'Полное Имя') 
WHERE contributor_name = 'старое_имя' AND user_id IS NULL;
```

### 2. Новые пользователи
Для пользователей, не обработанных скриптом:
```sql
UPDATE users 
SET first_name = 'Имя', last_name = 'Фамилия', username = 'Имя Фамилия'
WHERE id = USER_ID;
```

### 3. Проверка целостности
После миграции выполните:
```sql
-- Проверить все VK пользователей имеют русские имена
SELECT * FROM users WHERE vk_id IS NOT NULL AND (first_name ~ '[a-zA-Z]' OR last_name ~ '[a-zA-Z]');

-- Проверить связывание записей
SELECT COUNT(*) FROM budget WHERE type = 'Взнос' AND user_id IS NULL;
SELECT COUNT(*) FROM inventory WHERE created_by_user_id IS NULL;
```

## Откат изменений
Если что-то пошло не так, восстановите из резервной копии:
```bash
psql -d your_database < backup_before_migration.sql
```

## Проверка после миграции
1. Зайдите в админку и проверьте список пользователей
2. Посмотрите страницу участников - имена должны отображаться корректно
3. Проверьте инвентарь - владельцы должны быть с полными именами
4. Убедитесь что права доступа работают корректно 