# Руководство по SQL-миграции материалов инвентаря

## Описание

Созданы два SQL-скрипта для миграции материалов инвентаря:

1. **`migrate_inventory_materials.sql`** - полная версия с отчетами
2. **`migrate_materials_simple.sql`** - упрощенная версия для быстрого выполнения

## Что делают скрипты

Скрипты обновляют поле `material_type_id` в таблице `inventory` на основе существующих текстовых значений в поле `material`.

### Поддерживаемые материалы:

- **Металлы**: железо, сталь, латунь, бронза, серебро, медь, олово, свинец, золото, металл
- **Дерево**: дуб, ясень, береза/берёза, сосна, ель, липа, клен/клён, орех, дерево
- **Ткани**: лён/лен, шерсть, шелк/шёлк, хлопок, конопля, крапива, ткань
- **Кожа и мех**: кожа, замша, сыромять, мех, пергамент
- **Прочие**: кость, рог, янтарь, стекло, керамика, камень, глина
- **Комбинированные**: железо/дерево, кожа/металл, дерево/кожа, стекло/янтарь

### Специальные случаи:
- `"железо, ясень"` → `железо/дерево` (ID: 39)
- `"стекло\/янтарь"` → `стекло/янтарь` (ID: 42)
- `"дерево\/кожа"` → `дерево/кожа` (ID: 41)

## Использование

### Вариант 1: Полная миграция с отчетами

```sql
-- Выполните файл migrate_inventory_materials.sql
\i migrate_inventory_materials.sql
```

Этот скрипт:
1. Показывает статистику материалов до миграции
2. Выполняет обновления
3. Показывает результаты миграции
4. Показывает детальную статистику по обновленным материалам
5. Показывает необработанные материалы

### Вариант 2: Быстрая миграция

```sql
-- Выполните файл migrate_materials_simple.sql
\i migrate_materials_simple.sql
```

Этот скрипт просто выполняет все UPDATE-запросы и показывает итоговый счетчик.

## Безопасность

- Все запросы используют условие `AND material_type_id IS NULL`
- Это означает, что уже обработанные записи не будут затронуты
- Можно безопасно запускать скрипт несколько раз

## Ожидаемые результаты

На основе предоставленных данных будут обновлены следующие записи:

| Материал | Количество записей | → | material_type_id |
|----------|-------------------|---|------------------|
| железо | 10 | → | 1 |
| сталь | 1 | → | 2 |
| металл | 8 | → | 10 |
| дерево | 1 | → | 19 |
| лён | 7 | → | 20 |
| шерсть | 4 | → | 21 |
| стекло/янтарь | 3 | → | 42 |
| дерево/кожа | 2 | → | 41 |
| кожа | 14 | → | 27 |
| кость | 2 | → | 32 |
| ткань | 4 | → | 26 |

**Пропущены (нестандартные материалы):**
- "Пиксели" (тестовая запись)
- "Тест" (тестовая запись)

## После миграции

1. Новые предметы инвентаря будут использовать выпадающий список материалов
2. Старые записи получат связь с справочником материалов
3. Текстовое поле `material` сохраняется для обратной совместимости
4. Система будет работать с обоими полями: старым текстовым и новым справочным

## Проверка результатов

После выполнения миграции можно проверить результаты:

```sql
-- Статистика по обновленным материалам
SELECT 
    imt.name as "Материал",
    imt.category as "Категория",
    COUNT(i.id) as "Количество предметов"
FROM inventory i
JOIN inventory_material_types imt ON i.material_type_id = imt.id
GROUP BY imt.id, imt.name, imt.category, imt.sort_order
ORDER BY imt.sort_order, imt.name;

-- Необработанные материалы
SELECT id, material 
FROM inventory 
WHERE material IS NOT NULL 
AND material != ''
AND material_type_id IS NULL;
```