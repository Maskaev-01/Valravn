# üîß –ò—Ç–æ–≥–æ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è VK OAuth –∏ —Ä–æ—É—Ç–æ–≤

## ‚úÖ **–†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

### 1. üîó **Logout –Ω–µ —Ä–∞–±–æ—Ç–∞–ª**
**–ü—Ä–æ–±–ª–µ–º–∞:** `/logout` –≤–æ–∑–≤—Ä–∞—â–∞–ª 404 Not Found
**–†–µ—à–µ–Ω–∏–µ:** 
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –≤ `base.html`: `/logout` ‚Üí `/auth/logout`
- –î–æ–±–∞–≤–ª–µ–Ω —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ `main.py` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫

### 2. üéØ **VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏–ª, –Ω–æ –∏–º–µ–Ω–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª–∏—Å—å
**–†–µ—à–µ–Ω–∏–µ:**
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ VK API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ User-Agent –¥–ª—è –æ–±—Ö–æ–¥–∞ IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### 3. üìù **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –≤ —Ñ–æ—Ä–º–µ –∏ —Å—Ç–∏–ª—è—Ö
**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω action —Ñ–æ—Ä–º—ã: `/register` ‚Üí `/auth/register`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ "–í–æ–π—Ç–∏": `/login` ‚Üí `/auth/login`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è —Å login.html
- –ü–æ–∫–∞–∑–∞–Ω —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –≤ –ø–æ–¥—Å–∫–∞–∑–∫–µ: `valravn2024`

### 4. üé® **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å "—Å—ä–µ—Ö–∞–ª"**
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ –≤ login.html –∏ register.html
**–†–µ—à–µ–Ω–∏–µ:**
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π layout —Å `min-h-screen` –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ó–∞–º–µ–Ω–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ `valravn-*` –∫–ª–∞—Å—Å—ã –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ `red-*`

### 5. üìä **VK Whitelist —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- –§—É–Ω–∫—Ü–∏—è `create_or_update_vk_user` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç whitelist
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `is_whitelisted = True`
- –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –∞–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ —Å–æ–≥–ª–∞—Å–Ω–æ whitelist

---

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

### –†–æ—É—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ `/auth/login` (GET, POST) - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ `/auth/register` (GET, POST) - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è  
- ‚úÖ `/auth/logout` (GET) - –≤—ã—Ö–æ–¥
- ‚úÖ `/auth/vk/process` (POST) - VK ID –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ `/auth/admin/vk-whitelist` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ whitelist
- ‚úÖ `/logout` ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/logout`
- ‚úÖ `/login` ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth/login`

### VK OAuth –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```python
# –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
headers = {
    "User-Agent": "VKAndroidApp/7.45-13627 (Android 11; SDK 30; arm64-v8a; samsung SM-G991B; ru; 2340x1080)"
}

# –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
try:
    response = await client.get(f"{self.api_url}/users.get", params=params)
    data = response.json()
    if "error" in data:
        error_msg = data['error'].get('error_msg', 'Unknown VK API error')
        raise HTTPException(status_code=400, detail=f"VK API error: {error_msg}")
except httpx.TimeoutException:
    raise HTTPException(status_code=400, detail="VK API timeout")
```

### Whitelist –ª–æ–≥–∏–∫–∞:
```python
def create_or_update_vk_user(db: Session, vk_id: str, first_name: str, last_name: str, avatar_url: Optional[str] = None):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º whitelist
    whitelist_entry = db.query(VKWhitelist).filter(VKWhitelist.vk_id == vk_id).first()
    if not whitelist_entry:
        raise HTTPException(status_code=403, detail="VK ID –Ω–µ –≤ whitelist. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
    
    # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
    user.is_admin = 1 if whitelist_entry.is_admin else 0
    user.is_whitelisted = True
```

---

## üéØ **–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ–π VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**

```
VK Data received: {'access_token': 'vk2.a...', 'user_id': 333262027, 'expires_in': 3600}
Getting user info for VK ID: 333262027
VK API response: {'response': [{'id': 333262027, 'first_name': '–í–ª–∞–¥–∏–º–∏—Ä', 'last_name': '–ú–∞—Å–∫–∞–µ–≤', 'photo_100': '...'}]}
VK user info received: {'id': 333262027, 'first_name': '–í–ª–∞–¥–∏–º–∏—Ä', 'last_name': '–ú–∞—Å–∫–∞–µ–≤', 'photo_100': '...'}
Processing VK user: 333262027 - –í–ª–∞–¥–∏–º–∏—Ä –ú–∞—Å–∫–∞–µ–≤
User created/updated: –í–ª–∞–¥–∏–º–∏—Ä
INFO: "POST /auth/vk/process HTTP/1.1" 200 OK
INFO: "GET /dashboard HTTP/1.1" 200 OK
```

---

## üöÄ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

### 1. –û–±—ã—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
- URL: `/auth/login`
- –õ–æ–≥–∏–Ω: `–í–ª–∞–¥–∏–º–∏—Ä` 
- –ü–∞—Ä–æ–ª—å: `[–≤–∞—à_–ø–∞—Ä–æ–ª—å]`

### 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:
- URL: `/auth/register`
- –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥: `valravn2024`

### 3. VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
- –ù–∞–∂–∞—Ç—å —Å–∏–Ω—é—é –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ –í–ª–∞–¥–∏–º–∏—Ä"
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–º—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 4. Logout:
- –ù–∞–∂–∞—Ç—å "–í—ã—Ö–æ–¥" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
- –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ `/auth/login`

---

## üìã **Checklist –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

- [x] Logout —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞
- [x] VK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- [x] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏
- [x] –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- [x] VK whitelist –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [x] –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ VK API
- [x] –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –ø–æ–∫–∞–∑–∞–Ω –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

**üéØ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã!** 